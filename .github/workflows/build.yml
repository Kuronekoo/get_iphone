name: Build Windows Executable

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # Step 1: 检出代码
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    # Step 3: 安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    # Step 4: 打包为 .exe 文件
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --noconsole get_iphone_v2.py

    # Step 5: 验证 dist 目录
    - name: Verify dist directory
      shell: pwsh
      run: |
        $distPath = "${{ github.workspace }}\dist"
        if (-Not (Test-Path $distPath)) {
          Write-Host "Error: dist directory does not exist!"
          exit 1
        }
        $files = Get-ChildItem -Path $distPath
        if ($files.Count -eq 0) {
          Write-Host "Error: dist directory is empty!"
          exit 1
        }
        Write-Host "Dist directory contents:"
        Get-ChildItem -Path $distPath | ForEach-Object { Write-Host $_.Name }

    # Step 6: 提交 .exe 文件到仓库
    - name: Commit and push executable
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add dist/*.exe
        git commit -m "Add built executable"
        git push origin main
